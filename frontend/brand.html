<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Brand Comparison | Social Listening Dashboard</title>

    <link href="dist/output.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

    <!-- Load Shared Layout -->
    <div id="layout"></div>

    <script type="module" src="./src/js/pages/brand.js"></script>

    <script type="module">
        import { loadKeywordComparisonData, loadSentimentComparisonData, loadShareOfVoiceComparisonData, initTimeKeywordManagement, initSentimentComparisonExamplesToggle } from './src/js/pages/brand.js';
        import { loadLayout } from './src/js/layout-loader.js';
        import chartCache from './src/js/chartCache.js';

        // Check authentication
        if (!localStorage.getItem('authToken')) {
            window.location.href = 'login.html';
        }

        async function loadPage() {
            try {
                // Wait for Chart.js to be available
                let attempts = 0;
                while (typeof Chart === 'undefined' && attempts < 50) {
                    console.log('Waiting for Chart.js to load...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (typeof Chart === 'undefined') {
                    console.error('Chart.js failed to load');
                    document.body.innerHTML = '<div style="color: white; padding: 20px;">Error: Chart.js failed to load. Please refresh the page.</div>';
                    return;
                }

                console.log('Chart.js is loaded and ready');

                // Register ChartDataLabels if available
                if (typeof ChartDataLabels !== 'undefined') {
                    Chart.register(ChartDataLabels);
                    console.log('ChartDataLabels plugin registered');
                } else {
                    console.error('ChartDataLabels not available');
                }

                await loadLayout('brand');
            } catch (error) {
                console.error('Error in loadPage:', error);
                document.body.innerHTML = '<div style="color: white; padding: 20px;">Error loading page: ' + error.message + '</div>';
                return;
            }

            document.getElementById("page-content").innerHTML = `
                <h2 class="text-white text-2xl font-semibold mb-6">Brand Comparison</h2>

                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg">
                    <div class="text-white font-semibold text-lg mb-4 border-b border-[#3d4456] pb-2">
                        Brand Comparison Analysis
                    </div>
                    <div class="text-gray-400 mb-6">
                        Compare brand metrics across different time periods.
                    </div>

                    <!-- Brand Selection -->
                    <div class="mb-6">
                        <label class="text-gray-300 mr-2">Select Brand:</label>
                        <select id="brandSelector" class="bg-[#1f252f] text-white p-2 rounded">
                            <!-- Diaper Brands -->
                            <optgroup label="Diaper Brands">
                                <option value="mamypoko">MamyPoko</option>
                                <option value="huggies">Huggies</option>
                                <option value="pampers">Pampers</option>
                                <option value="drypers">Drypers</option>
                                <option value="merries">Merries</option>
                                <option value="offspring">Offspring</option>
                                <option value="rascal & friends">Rascal & Friends</option>
                            </optgroup>

                            <!-- Formula Milk Brands -->
                            <optgroup label="Formula Milk">
                                <option value="nan">Nan</option>
                                <option value="lactogen">Lactogen</option>
                                <option value="friso">Friso</option>
                                <option value="enfamil">Enfamil</option>
                                <option value="aptamil">Aptamil</option>
                                <option value="s26">S-26</option>
                                <option value="dumex dugro">Dumex Dugro</option>
                            </optgroup>

                            <!-- Baby Food & Organic Brands -->
                            <optgroup label="Baby Food">
                                <option value="applecrumbly">Applecrumble</option>
                                <option value="little blossom">Little Blossom</option>
                                <option value="rafferty garden">Rafferty's Garden</option>
                                <option value="happy baby organics">Happy Baby Organics</option>
                                <option value="heinz baby">Heinz Baby</option>
                                <option value="only organic">Only Organic</option>
                                <option value="holle">Holle</option>
                                <option value="ella kitchen">Ella's Kitchen</option>
                                <option value="gerber">Gerber</option>
                            </optgroup>

                            <!-- Hospitals & Healthcare -->
                            <optgroup label="Hospitals & Healthcare">
                                <option value="mount alvernia">Mount Alvernia Hospital</option>
                                <option value="thomson medical centre">Thomson Medical Centre</option>
                                <option value="mount elizabeth">Mount Elizabeth Hospital</option>
                                <option value="gleneagles">Gleneagles Hospital</option>
                                <option value="raffles hospital">Raffles Hospital</option>
                                <option value="national university hospital">National University Hospital</option>
                                <option value="kkh">KK Women & Children's Hospital</option>
                                <option value="parkway east hospital">Parkway East Hospital</option>
                                <option value="singapore general hospital">Singapore General Hospital</option>
                                <option value="sengkang general hospital">Sengkang General Hospital</option>
                                <option value="changi general hospital">Changi General Hospital</option>
                            </optgroup>

                            <!-- Baby Care Products -->
                            <optgroup label="Baby Care & Hygiene">
                                <option value="johnson">Johnson's Baby</option>
                                <option value="homie">Homie</option>
                                <option value="hey tiger">Hey Tiger</option>
                                <option value="nino nana">Nino Nana</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Charts Container -->
                    <div class="grid grid-cols-1 gap-6 mt-6" id="chartsContainer">

                        <!-- Keyword Comparison -->
                        <div class="bg-[#1f252f] p-4 rounded-lg" style="position: relative;">
                            <h3 class="text-white mb-4">Keyword Frequency Comparison</h3>

                            <!-- Time Controls for Keyword Chart -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-gray-300 block mb-2">Granularity:</label>
                                    <select id="keywordGranularitySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                        <option value="year">Year</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 1:</label>
                                    <input type="text" id="keywordTime1Input" placeholder="e.g., 2024 or 202401"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2024">
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 2:</label>
                                    <input type="text" id="keywordTime2Input" placeholder="e.g., 2025 or 202501"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2025">
                                </div>
                            </div>

                            <button id="keywordCompareBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white font-semibold py-2 px-4 rounded-lg mb-4">
                                Analyze
                            </button>

                            <canvas id="keywordCompareChart"></canvas>

                            <!-- Keyword Management Section -->
                            <div class="mt-4 pt-4 border-t border-[#3d4456]">
                                <div class="flex gap-2 mb-3">
                                    <input
                                        type="text"
                                        id="timeKeywordInput"
                                        placeholder="Add custom keyword..."
                                        class="flex-1 bg-[#252d3d] text-white px-3 py-2 rounded border border-[#3d4456] focus:outline-none focus:border-purple-500"
                                    />
                                    <button
                                        id="timeAddKeywordBtn"
                                        class="bg-[#C990B8] hover:bg-[#c967ac] text-white px-4 py-2 rounded font-medium">
                                        Add
                                    </button>
                                </div>
                                <div id="timeCustomKeywordsList" class="flex flex-wrap gap-2"></div>
                            </div>

                            <div id="loadingOverlay-keywordCompareChart" class="chart-loading-overlay">
                                <div class="loading-spinner"></div>
                                <p class="text-white text-sm font-semibold mt-3">Loading...</p>
                            </div>
                        </div>

                        <!-- Sentiment Comparison -->
                        <div class="bg-[#1f252f] p-4 rounded-lg" style="position: relative;">
                            <h3 class="text-white mb-4">Sentiment Comparison</h3>

                            <!-- Time Controls for Sentiment Chart -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-gray-300 block mb-2">Granularity:</label>
                                    <select id="sentimentGranularitySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                        <option value="year">Year</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 1:</label>
                                    <input type="text" id="sentimentTime1Input" placeholder="e.g., 2024 or 202401"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2024">
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 2:</label>
                                    <input type="text" id="sentimentTime2Input" placeholder="e.g., 2025 or 202501"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2025">
                                </div>
                            </div>

                            <button id="sentimentCompareBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white font-semibold py-2 px-4 rounded-lg mb-4">
                                Analyze
                            </button>

                            <!-- Total Mentions Display -->
                            <div id="sentimentTotalMentions" class="mb-4"></div>

                            <canvas id="sentimentCompareChart"></canvas>

                            <!-- Top Messages Section -->
                            <div id="sentimentComparisonExamples" class="mt-6 pt-4 border-t border-[#3d4456]">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-white font-semibold">Top Messages</h4>
                                    <button id="toggleSentimentComparisonExamples" class="text-gray-400 hover:text-white text-sm font-medium">
                                        <span id="toggleSentimentComparisonExamplesText">Hide</span>
                                        <span id="toggleSentimentComparisonExamplesIcon">â–¼</span>
                                    </button>
                                </div>
                                <div id="sentimentComparisonExamplesList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Examples will be populated here -->
                                </div>
                            </div>

                            <div id="loadingOverlay-sentimentCompareChart" class="chart-loading-overlay">
                                <div class="loading-spinner"></div>
                                <p class="text-white text-sm font-semibold mt-3">Loading...</p>
                            </div>
                        </div>

                        <!-- Share of Voice Comparison -->
                        <div class="bg-[#1f252f] p-4 rounded-lg" style="position: relative;">
                            <h3 class="text-white mb-4">Share of Voice Comparison</h3>

                            <!-- Category Selection for Share of Voice -->
                            <div class="mb-4">
                                <label class="text-gray-300 block mb-2">Select Category:</label>
                                <select id="shareOfVoiceCategorySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                    <option value="diaper">Diaper</option>
                                    <option value="formula milk">Formula Milk</option>
                                    <option value="weaning">Weaning / Baby Food</option>
                                    <option value="hospital">Hospital</option>
                                </select>
                            </div>

                            <!-- Time Controls for Share of Voice Chart -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-gray-300 block mb-2">Granularity:</label>
                                    <select id="shareOfVoiceGranularitySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                        <option value="year">Year</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 1:</label>
                                    <input type="text" id="shareOfVoiceTime1Input" placeholder="e.g., 2024 or 202401"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2024">
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 2:</label>
                                    <input type="text" id="shareOfVoiceTime2Input" placeholder="e.g., 2025 or 202501"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2025">
                                </div>
                            </div>

                            <button id="shareOfVoiceCompareBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white font-semibold py-2 px-4 rounded-lg mb-4">
                                Analyze
                            </button>

                            <!-- Total Mentions Display -->
                            <div id="shareOfVoiceTotalMentions" class="mb-4"></div>

                            <canvas id="shareOfVoiceCompareChart"></canvas>
                            <div id="loadingOverlay-shareOfVoiceCompareChart" class="chart-loading-overlay">
                                <div class="loading-spinner"></div>
                                <p class="text-white text-sm font-semibold mt-3">Loading...</p>
                            </div>
                        </div>

                    </div>

                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }

                        .chart-loading-overlay {
                            display: none;
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(31, 37, 47, 0.95);
                            z-index: 10;
                            border-radius: 8px;
                            align-items: center;
                            justify-content: center;
                            flex-direction: column;
                        }

                        .chart-loading-overlay.active {
                            display: flex;
                        }

                        .loading-spinner {
                            border: 3px solid #3d4456;
                            border-top: 3px solid #4ab4deff;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                        }
                    </style>
                </div>
            `;

            // Wait for canvases to be rendered
            await waitForCanvasesReady();

            // Add event listeners for each chart's compare button
            const keywordCompareBtn = document.getElementById("keywordCompareBtn");
            if (keywordCompareBtn) {
                keywordCompareBtn.addEventListener('click', async function() {
                    const brand = document.getElementById("brandSelector").value;
                    const granularity = document.getElementById("keywordGranularitySelector").value;
                    const time1 = document.getElementById("keywordTime1Input").value.trim();
                    const time2 = document.getElementById("keywordTime2Input").value.trim();

                    // Save parameters for persistence
                    chartCache.saveChartParams('brand', 'keywordCompareChart', { brand, granularity, time1, time2 });

                    console.log('Comparing Keyword:', { brand, granularity, time1, time2 });
                    await loadKeywordComparisonData(brand, granularity, time1, time2);
                });
            }

            const sentimentCompareBtn = document.getElementById("sentimentCompareBtn");
            if (sentimentCompareBtn) {
                sentimentCompareBtn.addEventListener('click', async function() {
                    const brand = document.getElementById("brandSelector").value;
                    const granularity = document.getElementById("sentimentGranularitySelector").value;
                    const time1 = document.getElementById("sentimentTime1Input").value.trim();
                    const time2 = document.getElementById("sentimentTime2Input").value.trim();

                    // Save parameters for persistence
                    chartCache.saveChartParams('brand', 'sentimentCompareChart', { brand, granularity, time1, time2 });

                    console.log('Comparing Sentiment:', { brand, granularity, time1, time2 });
                    await loadSentimentComparisonData(brand, granularity, time1, time2);
                });
            }

            const shareOfVoiceCompareBtn = document.getElementById("shareOfVoiceCompareBtn");
            if (shareOfVoiceCompareBtn) {
                shareOfVoiceCompareBtn.addEventListener('click', async function() {
                    const category = document.getElementById("shareOfVoiceCategorySelector").value;
                    const granularity = document.getElementById("shareOfVoiceGranularitySelector").value;
                    const time1 = document.getElementById("shareOfVoiceTime1Input").value.trim();
                    const time2 = document.getElementById("shareOfVoiceTime2Input").value.trim();

                    // Save parameters for persistence
                    chartCache.saveChartParams('brand', 'shareOfVoiceCompareChart', { category, granularity, time1, time2 });

                    console.log('Comparing Share of Voice:', { category, granularity, time1, time2 });
                    await loadShareOfVoiceComparisonData(category, granularity, time1, time2);
                });
            }

            // Initialize keyword management for time comparison
            initTimeKeywordManagement();

            // Initialize sentiment comparison examples toggle
            initSentimentComparisonExamplesToggle();

            // Listen for group chat changes - note: charts won't auto-reload since they require user-configured parameters
            // User needs to click Analyze button after changing group chat selection
            // Use flag to prevent duplicate listener registration
            if (!window.brandPageGroupChatHandlerAttached) {
                window.addEventListener('groupChatChanged', function() {
                    console.log('Group chat selection changed. Click Analyze to see updated results.');
                });
                window.brandPageGroupChatHandlerAttached = true;
            }

            // Auto-load charts from saved parameters
            const savedParams = chartCache.getPageParams('brand');
            console.log('[Brand] Auto-loading charts with saved params:', savedParams);

            if (savedParams.keywordCompareChart) {
                const { brand, granularity, time1, time2 } = savedParams.keywordCompareChart;
                document.getElementById("brandSelector").value = brand;
                document.getElementById("keywordGranularitySelector").value = granularity;
                document.getElementById("keywordTime1Input").value = time1;
                document.getElementById("keywordTime2Input").value = time2;
                await loadKeywordComparisonData(brand, granularity, time1, time2);
            }

            if (savedParams.sentimentCompareChart) {
                const { brand, granularity, time1, time2 } = savedParams.sentimentCompareChart;
                document.getElementById("brandSelector").value = brand;
                document.getElementById("sentimentGranularitySelector").value = granularity;
                document.getElementById("sentimentTime1Input").value = time1;
                document.getElementById("sentimentTime2Input").value = time2;
                await loadSentimentComparisonData(brand, granularity, time1, time2);
            }

            if (savedParams.shareOfVoiceCompareChart) {
                const { category, granularity, time1, time2 } = savedParams.shareOfVoiceCompareChart;
                document.getElementById("shareOfVoiceCategorySelector").value = category;
                document.getElementById("shareOfVoiceGranularitySelector").value = granularity;
                document.getElementById("shareOfVoiceTime1Input").value = time1;
                document.getElementById("shareOfVoiceTime2Input").value = time2;
                await loadShareOfVoiceComparisonData(category, granularity, time1, time2);
            }
        }

        // Helper function to ensure canvases are ready
        async function waitForCanvasesReady() {
            const canvasIds = ['keywordCompareChart', 'sentimentCompareChart', 'shareOfVoiceCompareChart'];
            const maxWait = 5000;
            const startTime = Date.now();

            while (Date.now() - startTime < maxWait) {
                const allReady = canvasIds.every(id => {
                    const canvas = document.getElementById(id);
                    if (!canvas) return false;

                    const rect = canvas.getBoundingClientRect();
                    const style = window.getComputedStyle(canvas);

                    return (
                        canvas.offsetWidth > 0 &&
                        canvas.offsetHeight > 0 &&
                        rect.width > 0 &&
                        rect.height > 0 &&
                        style.display !== 'none' &&
                        style.visibility !== 'hidden' &&
                        style.opacity !== '0'
                    );
                });

                if (allReady) {
                    console.log('All canvases are ready');
                    return true;
                }

                await new Promise(resolve => requestAnimationFrame(resolve));
            }

            console.warn('Timeout waiting for canvases');
            return false;
        }

        // Ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM Content Loaded');
                loadPage().catch(err => {
                    console.error('Fatal error loading page:', err);
                    document.body.innerHTML = '<div style="color: white; padding: 20px;">Fatal error: ' + err.message + '</div>';
                });
            });
        } else {
            console.log('DOM already ready, loading page');
            loadPage().catch(err => {
                console.error('Fatal error loading page:', err);
                document.body.innerHTML = '<div style="color: white; padding: 20px;">Fatal error: ' + err.message + '</div>';
            });
        }
    </script>

</body>
</html>
