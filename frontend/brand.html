<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Brand Comparison | Social Listening Dashboard</title>

    <link href="dist/output.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

    <!-- Load Shared Layout -->
    <div id="layout"></div>

    <script type="module" src="./src/js/pages/brand.js"></script>

    <script type="module">
        import { loadKeywordComparisonData, loadSentimentComparisonData, loadBrandPerceptionComparisonData, initTimeKeywordManagement, initSentimentComparisonExamplesToggle, initBrandKeywordFilter, initBrandPerceptionFilter } from './src/js/pages/brand.js';
        import { loadLayout } from './src/js/layout-loader.js';
        import chartCache from './src/js/chartCache.js';
        import { dropList } from './src/js/api/api.js';
        window.dropList = dropList;



        // Check authentication
        if (!localStorage.getItem('authToken')) {
            window.location.href = 'login.html';
        }

        async function populateBrandDropdown() {
            const selector = document.getElementById('brandSelector');
            if (!selector) return;

            try {
                const data = await dropList();

                console.log("Dropdown response:", data);

                const brands = data.brand || [];

                // Sort brands alphabetically
                brands.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

                selector.innerHTML = "";

                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b.charAt(0).toUpperCase() + b.slice(1);
                    selector.appendChild(opt);
                });

                console.log("Brand dropdown populated (alphabetically):", brands);

            } catch (err) {
                console.error("Failed to populate brand dropdown:", err);
            }
        }



        async function loadPage() {
            try {
                // Wait for Chart.js to be available
                let attempts = 0;
                while (typeof Chart === 'undefined' && attempts < 50) {
                    console.log('Waiting for Chart.js to load...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (typeof Chart === 'undefined') {
                    console.error('Chart.js failed to load');
                    document.body.innerHTML = '<div style="color: white; padding: 20px;">Error: Chart.js failed to load. Please refresh the page.</div>';
                    return;
                }

                console.log('Chart.js is loaded and ready');

                // Register ChartDataLabels if available
                if (typeof ChartDataLabels !== 'undefined') {
                    Chart.register(ChartDataLabels);
                    console.log('ChartDataLabels plugin registered');
                } else {
                    console.error('ChartDataLabels not available');
                }

                await loadLayout('brand');
            } catch (error) {
                console.error('Error in loadPage:', error);
                document.body.innerHTML = '<div style="color: white; padding: 20px;">Error loading page: ' + error.message + '</div>';
                return;
            }

            document.getElementById("page-content").innerHTML = `
                <h2 class="text-white text-2xl font-semibold mb-6">Brand Comparison</h2>

                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg">
                    <div class="text-white font-semibold text-lg mb-4 border-b border-[#3d4456] pb-2">
                        Brand Comparison Analysis
                    </div>
                    <div class="text-gray-400 mb-6">
                        Compare brand metrics across different time periods.
                    </div>

                    <!-- Brand Selection -->
                    <div class="mb-6">
                        <label class="text-gray-300 mr-2">Select Brand:</label>
                        <select id="brandSelector" class="bg-[#1f252f] text-white p-2 rounded">

                        </select>
                    </div>

                    <!-- Charts Container -->
                    <div class="grid grid-cols-1 gap-6 mt-6" id="chartsContainer">

                        <!-- Keyword Comparison -->
                        <div class="bg-[#1f252f] p-4 rounded-lg" style="position: relative;">
                            <h3 class="text-white mb-2">Keyword Frequency Comparison</h3>
                            <p class="text-gray-400 text-sm mb-4">This chart shows top default keyword count by brand. The logic is to use +/-6 sentences around the brand name to calculate the count of the brand. You can add/remove words from this chart (permanent) or temporarily hide filler words from the display.</p>

                            <!-- Time Controls for Keyword Chart -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-gray-300 block mb-2">Granularity:</label>
                                    <select id="keywordGranularitySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                        <option value="year">Year</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 1:</label>
                                    <input type="text" id="keywordTime1Input" placeholder="e.g., 2024 or 202401"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2024">
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 2:</label>
                                    <input type="text" id="keywordTime2Input" placeholder="e.g., 2025 or 202501"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2025">
                                </div>
                            </div>

                            <button id="keywordCompareBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white font-semibold py-2 px-4 rounded-lg mb-4">
                                Analyze
                            </button>

                            <canvas id="keywordCompareChart"></canvas>

                            <!-- Keyword Management Section -->
                            <div class="mt-4 pt-4 border-t border-[#3d4456]">
                                <div class="flex gap-2 mb-3">
                                    <input
                                        type="text"
                                        id="timeKeywordInput"
                                        placeholder="Add custom keyword..."
                                        class="flex-1 bg-[#252d3d] text-white px-3 py-2 rounded border border-[#3d4456] focus:outline-none focus:border-purple-500"
                                    />
                                    <button
                                        id="timeAddKeywordBtn"
                                        class="bg-[#C990B8] hover:bg-[#c967ac] text-white px-4 py-2 rounded font-medium">
                                        Add
                                    </button>
                                </div>
                                <div id="timeCustomKeywordsList" class="flex flex-wrap gap-2"></div>
                            </div>

                            <!-- Word Filtering Section -->
                            <div class="mt-4 pt-4 border-t border-[#3d4456]">
                                <div class="flex gap-2 mb-3">
                                    <input
                                        type="text"
                                        id="brandKeywordFilterInput"
                                        placeholder="Enter word(s) to remove (comma or space separated)..."
                                        class="flex-1 bg-[#252d3d] text-white px-3 py-2 rounded border border-[#3d4456] focus:outline-none focus:border-purple-500"
                                    />
                                    <button
                                        id="hideBrandKeywordBtn"
                                        class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded font-medium">
                                        Remove 
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <p class="text-gray-400 text-sm mb-2">Hidden Words:</p>
                                    <div id="brandKeywordHiddenWordsList" class="flex flex-wrap gap-2">
                                        <span class="text-gray-500 text-sm">No hidden words</span>
                                    </div>
                                </div>
                            </div>

                            <div id="loadingOverlay-keywordCompareChart" class="chart-loading-overlay">
                                <div class="loading-spinner"></div>
                                <p class="text-white text-sm font-semibold mt-3">Loading...</p>
                            </div>
                        </div>

                        <!-- Sentiment Comparison -->
                        <div class="bg-[#1f252f] p-4 rounded-lg" style="position: relative;">
                            <h3 class="text-white mb-2">Sentiment Comparison</h3>
                            <p class="text-gray-400 text-sm mb-4">This shows the % of positive, negative, neutral sentiments regarding the brand. You can edit the sentiment (permanent change).</p>

                            <!-- Time Controls for Sentiment Chart -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-gray-300 block mb-2">Granularity:</label>
                                    <select id="sentimentGranularitySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                        <option value="year">Year</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 1:</label>
                                    <input type="text" id="sentimentTime1Input" placeholder="e.g., 2024 or 202401"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2024">
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 2:</label>
                                    <input type="text" id="sentimentTime2Input" placeholder="e.g., 2025 or 202501"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2025">
                                </div>
                            </div>

                            <button id="sentimentCompareBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white font-semibold py-2 px-4 rounded-lg mb-4">
                                Analyze
                            </button>

                            <!-- Total Mentions Display -->
                            <div id="sentimentTotalMentions" class="mb-4"></div>

                            <canvas id="sentimentCompareChart"></canvas>

                            <!-- Top Messages Section -->
                            <div id="sentimentComparisonExamples" class="mt-6 pt-4 border-t border-[#3d4456]">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-white font-semibold">Top Messages</h4>
                                    <button id="toggleSentimentComparisonExamples" class="text-gray-400 hover:text-white text-sm font-medium">
                                        <span id="toggleSentimentComparisonExamplesText">Hide</span>
                                        <span id="toggleSentimentComparisonExamplesIcon">â–¼</span>
                                    </button>
                                </div>
                                <div id="sentimentComparisonExamplesList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Examples will be populated here -->
                                </div>
                            </div>

                            <div id="loadingOverlay-sentimentCompareChart" class="chart-loading-overlay">
                                <div class="loading-spinner"></div>
                                <p class="text-white text-sm font-semibold mt-3">Loading...</p>
                            </div>
                        </div>

                        <!-- Consumer Perception Comparison -->
                        <div class="bg-[#1f252f] p-4 rounded-lg" style="position: relative;">
                            <h3 class="text-white mb-2">Consumer Perception Comparison</h3>
                            <p class="text-gray-400 text-sm mb-4">This tracks what words mothers are associating with the brand - determined by the model. You can temporarily hide filler words from the display.</p>

                            <!-- Time Controls for Consumer Perception Chart -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-gray-300 block mb-2">Granularity:</label>
                                    <select id="brandPerceptionGranularitySelector" class="bg-[#2a3142] text-white p-2 rounded w-full">
                                        <option value="year">Year</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 1:</label>
                                    <input type="text" id="brandPerceptionTime1Input" placeholder="e.g., 2024 or 202401"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2024">
                                </div>
                                <div>
                                    <label class="text-gray-300 block mb-2">Time Period 2:</label>
                                    <input type="text" id="brandPerceptionTime2Input" placeholder="e.g., 2025 or 202501"
                                        class="bg-[#2a3142] text-white p-2 rounded w-full" value="2025">
                                </div>
                            </div>

                            <button id="brandPerceptionCompareBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white font-semibold py-2 px-4 rounded-lg mb-4">
                                Analyze
                            </button>

                            <canvas id="brandPerceptionCompareChart"></canvas>

                            <!-- Word Filtering Section -->
                            <div class="mt-6 pt-4 border-t border-[#3d4456]">
                                <h4 class="text-white font-semibold mb-3">Filter Words</h4>
                                <div class="flex gap-2 mb-3">
                                    <input
                                        type="text"
                                        id="brandPerceptionWordFilterInput"
                                        placeholder="Enter word(s) to hide (comma or space separated)..."
                                        class="flex-1 bg-[#252d3d] text-white px-3 py-2 rounded border border-[#3d4456] focus:outline-none focus:border-purple-500"
                                    />
                                    <button
                                        id="hideBrandPerceptionWordBtn"
                                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-medium">
                                        Hide
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <p class="text-gray-400 text-sm mb-2">Hidden Words:</p>
                                    <div id="brandPerceptionHiddenWordsList" class="flex flex-wrap gap-2">
                                        <span class="text-gray-500 text-sm">No hidden words</span>
                                    </div>
                                </div>
                            </div>

                            <div id="loadingOverlay-brandPerceptionCompareChart" class="chart-loading-overlay">
                                <div class="loading-spinner"></div>
                                <p class="text-white text-sm font-semibold mt-3">Loading...</p>
                            </div>
                        </div>

                    </div>

                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }

                        .chart-loading-overlay {
                            display: none;
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(31, 37, 47, 0.95);
                            z-index: 10;
                            border-radius: 8px;
                            align-items: center;
                            justify-content: center;
                            flex-direction: column;
                        }

                        .chart-loading-overlay.active {
                            display: flex;
                        }

                        .loading-spinner {
                            border: 3px solid #3d4456;
                            border-top: 3px solid #4ab4deff;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                        }
                    </style>
                </div>
            `;
            await populateBrandDropdown();

            // Wait for canvases to be rendered
            await waitForCanvasesReady();

            // Add event listeners for each chart's compare button
            const keywordCompareBtn = document.getElementById("keywordCompareBtn");
            if (keywordCompareBtn) {
                keywordCompareBtn.addEventListener('click', async function() {
                    const brand = document.getElementById("brandSelector").value;
                    const granularity = document.getElementById("keywordGranularitySelector").value;
                    const time1 = document.getElementById("keywordTime1Input").value.trim();
                    const time2 = document.getElementById("keywordTime2Input").value.trim();

                    // Save parameters for persistence
                    chartCache.saveChartParams('brand', 'keywordCompareChart', { brand, granularity, time1, time2 });

                    console.log('Comparing Keyword:', { brand, granularity, time1, time2 });
                    await loadKeywordComparisonData(brand, granularity, time1, time2);
                });
            }

            const sentimentCompareBtn = document.getElementById("sentimentCompareBtn");
            if (sentimentCompareBtn) {
                sentimentCompareBtn.addEventListener('click', async function() {
                    const brand = document.getElementById("brandSelector").value;
                    const granularity = document.getElementById("sentimentGranularitySelector").value;
                    const time1 = document.getElementById("sentimentTime1Input").value.trim();
                    const time2 = document.getElementById("sentimentTime2Input").value.trim();

                    // Save parameters for persistence
                    chartCache.saveChartParams('brand', 'sentimentCompareChart', { brand, granularity, time1, time2 });

                    console.log('Comparing Sentiment:', { brand, granularity, time1, time2 });
                    await loadSentimentComparisonData(brand, granularity, time1, time2);
                });
            }

            const brandPerceptionCompareBtn = document.getElementById("brandPerceptionCompareBtn");
            if (brandPerceptionCompareBtn) {
                brandPerceptionCompareBtn.addEventListener('click', async function() {
                    const brand = document.getElementById("brandSelector").value;
                    const granularity = document.getElementById("brandPerceptionGranularitySelector").value;
                    const time1 = document.getElementById("brandPerceptionTime1Input").value.trim();
                    const time2 = document.getElementById("brandPerceptionTime2Input").value.trim();

                    // Save parameters for persistence
                    chartCache.saveChartParams('brand', 'brandPerceptionCompareChart', { brand, granularity, time1, time2 });

                    console.log('Comparing Brand Consumer Perception:', { brand, granularity, time1, time2 });
                    await loadBrandPerceptionComparisonData(brand, granularity, time1, time2);
                });
            }

            // Initialize keyword management for time comparison
            initTimeKeywordManagement();

            // Initialize sentiment comparison examples toggle
            initSentimentComparisonExamplesToggle();

            // Initialize brand keyword filter
            initBrandKeywordFilter();

            // Initialize brand perception filter
            initBrandPerceptionFilter();

            // Listen for group chat changes - note: charts won't auto-reload since they require user-configured parameters
            // User needs to click Analyze button after changing group chat selection
            // Use flag to prevent duplicate listener registration
            if (!window.brandPageGroupChatHandlerAttached) {
                window.addEventListener('groupChatChanged', function() {
                    console.log('Group chat selection changed. Click Analyze to see updated results.');
                });
                window.brandPageGroupChatHandlerAttached = true;
            }

            // Restore saved parameters to form fields (but don't auto-load)
            const savedParams = chartCache.getPageParams('brand');
            console.log('[Brand] Restoring saved params to form fields:', savedParams);

            if (savedParams.keywordCompareChart) {
                const { brand, granularity, time1, time2 } = savedParams.keywordCompareChart;
                document.getElementById("brandSelector").value = brand;
                document.getElementById("keywordGranularitySelector").value = granularity;
                document.getElementById("keywordTime1Input").value = time1;
                document.getElementById("keywordTime2Input").value = time2;
                // Removed auto-load - user must click "Analyze" button
            }

            if (savedParams.sentimentCompareChart) {
                const { brand, granularity, time1, time2 } = savedParams.sentimentCompareChart;
                document.getElementById("brandSelector").value = brand;
                document.getElementById("sentimentGranularitySelector").value = granularity;
                document.getElementById("sentimentTime1Input").value = time1;
                document.getElementById("sentimentTime2Input").value = time2;
                // Removed auto-load - user must click "Analyze" button
            }
        }

        // Helper function to ensure canvases are ready
        async function waitForCanvasesReady() {
            const canvasIds = ['keywordCompareChart', 'sentimentCompareChart'];
            const maxWait = 5000;
            const startTime = Date.now();

            while (Date.now() - startTime < maxWait) {
                const allReady = canvasIds.every(id => {
                    const canvas = document.getElementById(id);
                    if (!canvas) return false;

                    const rect = canvas.getBoundingClientRect();
                    const style = window.getComputedStyle(canvas);

                    return (
                        canvas.offsetWidth > 0 &&
                        canvas.offsetHeight > 0 &&
                        rect.width > 0 &&
                        rect.height > 0 &&
                        style.display !== 'none' &&
                        style.visibility !== 'hidden' &&
                        style.opacity !== '0'
                    );
                });

                if (allReady) {
                    console.log('All canvases are ready');
                    return true;
                }

                await new Promise(resolve => requestAnimationFrame(resolve));
            }

            console.warn('Timeout waiting for canvases');
            return false;
        }

        // Ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM Content Loaded');
                loadPage().catch(err => {
                    console.error('Fatal error loading page:', err);
                    document.body.innerHTML = '<div style="color: white; padding: 20px;">Fatal error: ' + err.message + '</div>';
                });
            });
        } else {
            console.log('DOM already ready, loading page');
            loadPage().catch(err => {
                console.error('Fatal error loading page:', err);
                document.body.innerHTML = '<div style="color: white; padding: 20px;">Fatal error: ' + err.message + '</div>';
            });
        }
    </script>

</body>
</html>
