<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Category Comparison | Social Listening Dashboard</title>

    <link href="dist/output.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

    <!-- Load Shared Layout -->
    <div id="layout"></div>

    <script type="module">
        import { loadLayout } from './src/js/layout-loader.js';
        import { loadComparisonKeywordFrequencyData, loadConsumerPerceptionData, initCategoryPerceptionWordFilter } from './src/js/pages/category.js';
        import chartCache from './src/js/chartCache.js';

        // Check authentication
        if (!localStorage.getItem('authToken')) {
            window.location.href = 'login.html';
        }

        async function loadPage() {
            // Wait for Chart.js to be available
            while (typeof Chart === 'undefined') {
                console.log('Waiting for Chart.js to load...');
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Load layout
            await loadLayout('category');

            // Insert this page's content
            document.getElementById("page-content").innerHTML = `
                <h2 class="text-white text-2xl font-semibold mb-6">Category Comparison</h2>

                <!-- Category Selector Section -->
                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg mb-6">
                    <div class="text-white font-semibold text-lg mb-4">
                        Select Category
                    </div>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-gray-400 text-sm mb-2">Category</label>
                            <select id="categorySelector" class="w-full bg-[#1e2433] text-white border border-[#3d4456] rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                                <option value="diaper">Diaper</option>
                                <option value="formula milk">Formula Milk</option>
                                <option value="weaning">Weaning</option>
                                <option value="hospital">Hospital</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Comparison Keyword Frequency Chart -->
                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4 border-b border-[#3d4456] pb-2">
                        <div class="text-white font-semibold text-lg">
                            Keyword Frequency
                        </div>
                        <button id="analyzeKeywordFrequencyBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white px-4 py-1 rounded text-sm font-semibold transition">
                            Analyze
                        </button>
                    </div>

                    <!-- Time Controls for Keyword Frequency -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="text-gray-300 block mb-2">Granularity:</label>
                            <select id="keywordGranularitySelector" class="bg-[#1e2433] text-white p-2 rounded w-full border border-[#3d4456]">
                                <option value="year">Year</option>
                                <option value="month">Month</option>
                                <option value="quarter">Quarter</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-300 block mb-2">Time Period 1:</label>
                            <input type="text" id="keywordTime1Input" placeholder="e.g., 2024 or 202401"
                                class="bg-[#1e2433] text-white p-2 rounded w-full border border-[#3d4456]" value="2024">
                        </div>
                        <div>
                            <label class="text-gray-300 block mb-2">Time Period 2:</label>
                            <input type="text" id="keywordTime2Input" placeholder="e.g., 2025 or 202501"
                                class="bg-[#1e2433] text-white p-2 rounded w-full border border-[#3d4456]" value="2025">
                        </div>
                    </div>

                    <div class="relative" style="min-height: 400px; position: relative;">
                        <canvas id="comparisonKeywordChart"></canvas>
                        <div id="loadingOverlay-comparisonKeywordChart" class="chart-loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Consumer Perception Chart -->
                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4 border-b border-[#3d4456] pb-2">
                        <div class="text-white font-semibold text-lg">
                            Consumer Perception
                        </div>
                        <button id="analyzeConsumerPerceptionBtn" class="bg-[#C990B8] hover:bg-[#c967ac] text-white px-4 py-1 rounded text-sm font-semibold transition">
                            Analyze
                        </button>
                    </div>

                    <!-- Time Controls for Consumer Perception -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="text-gray-300 block mb-2">Granularity:</label>
                            <select id="perceptionGranularitySelector" class="bg-[#1e2433] text-white p-2 rounded w-full border border-[#3d4456]">
                                <option value="year">Year</option>
                                <option value="month">Month</option>
                                <option value="quarter">Quarter</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-300 block mb-2">Time Period 1:</label>
                            <input type="text" id="perceptionTime1Input" placeholder="e.g., 2024 or 202401"
                                class="bg-[#1e2433] text-white p-2 rounded w-full border border-[#3d4456]" value="2024">
                        </div>
                        <div>
                            <label class="text-gray-300 block mb-2">Time Period 2:</label>
                            <input type="text" id="perceptionTime2Input" placeholder="e.g., 2025 or 202501"
                                class="bg-[#1e2433] text-white p-2 rounded w-full border border-[#3d4456]" value="2025">
                        </div>
                    </div>

                    <div class="relative" style="min-height: 400px; position: relative;">
                        <canvas id="consumerPerceptionChart"></canvas>
                        <div id="loadingOverlay-consumerPerceptionChart" class="chart-loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>

                    <!-- Word Filtering Section -->
                    <div class="mt-6 pt-4 border-t border-[#3d4456]">
                        <h4 class="text-white font-semibold mb-3">Filter Words</h4>
                        <div class="flex gap-2 mb-3">
                            <input
                                type="text"
                                id="perceptionCategoryWordFilterInput"
                                placeholder="Enter word(s) to hide (comma or space separated)..."
                                class="flex-1 bg-[#252d3d] text-white px-3 py-2 rounded border border-[#3d4456] focus:outline-none focus:border-purple-500"
                            />
                            <button
                                id="removePerceptionWordBtn"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-medium">
                                Hide
                            </button>
                        </div>
                        <div class="mt-3">
                            <p class="text-gray-400 text-sm mb-2">Hidden Words:</p>
                            <div id="perceptionCategoryHiddenWordsList" class="flex flex-wrap gap-2">
                                <span class="text-gray-500 text-sm">No hidden words</span>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }

                    .chart-loading-overlay {
                        display: none;
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(31, 37, 47, 0.95);
                        z-index: 10;
                        border-radius: 8px;
                        align-items: center;
                        justify-content: center;
                        flex-direction: column;
                    }

                    .chart-loading-overlay.active {
                        display: flex;
                    }

                    .loading-spinner {
                        border: 3px solid #3d4456;
                        border-top: 3px solid #4ab4deff;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;

            // Add event listeners for individual analyze buttons
            document.getElementById('analyzeKeywordFrequencyBtn').addEventListener('click', async () => {
                const category = document.getElementById('categorySelector').value;
                const granularity = document.getElementById('keywordGranularitySelector').value;
                const time1 = document.getElementById('keywordTime1Input').value.trim();
                const time2 = document.getElementById('keywordTime2Input').value.trim();

                // Save parameters for persistence
                chartCache.saveChartParams('category', 'comparisonKeywordChart', { category, granularity, time1, time2 });

                console.log('Analyzing Keyword Frequency for category:', { category, granularity, time1, time2 });
                await loadComparisonKeywordFrequencyData(category, granularity, time1, time2);
            });

            document.getElementById('analyzeConsumerPerceptionBtn').addEventListener('click', async () => {
                const category = document.getElementById('categorySelector').value;
                const granularity = document.getElementById('perceptionGranularitySelector').value;
                const time1 = document.getElementById('perceptionTime1Input').value.trim();
                const time2 = document.getElementById('perceptionTime2Input').value.trim();

                // Save parameters for persistence
                chartCache.saveChartParams('category', 'consumerPerceptionChart', { category, granularity, time1, time2 });

                console.log('Analyzing Consumer Perception for category:', { category, granularity, time1, time2 });
                await loadConsumerPerceptionData(category, granularity, time1, time2);
            });

            // Initialize word filter for consumer perception
            initCategoryPerceptionWordFilter();

            // Listen for group chat changes - note: charts won't auto-reload since they require user-configured parameters
            // User needs to click Analyze button after changing group chat selection
            // Use flag to prevent duplicate listener registration
            if (!window.categoryPageGroupChatHandlerAttached) {
                window.addEventListener('groupChatChanged', function() {
                    console.log('Group chat selection changed. Click Analyze to see updated results.');
                });
                window.categoryPageGroupChatHandlerAttached = true;
            }

            // Auto-load charts from saved parameters
            const savedParams = chartCache.getPageParams('category');
            console.log('[Category] Auto-loading charts with saved params:', savedParams);

            if (savedParams.comparisonKeywordChart) {
                const { category, granularity, time1, time2 } = savedParams.comparisonKeywordChart;
                document.getElementById('categorySelector').value = category;
                document.getElementById('keywordGranularitySelector').value = granularity;
                document.getElementById('keywordTime1Input').value = time1;
                document.getElementById('keywordTime2Input').value = time2;
                await loadComparisonKeywordFrequencyData(category, granularity, time1, time2);
            }

            if (savedParams.consumerPerceptionChart) {
                const { category, granularity, time1, time2 } = savedParams.consumerPerceptionChart;
                document.getElementById('categorySelector').value = category;
                document.getElementById('perceptionGranularitySelector').value = granularity;
                document.getElementById('perceptionTime1Input').value = time1;
                document.getElementById('perceptionTime2Input').value = time2;
                await loadConsumerPerceptionData(category, granularity, time1, time2);
            }
        }

        loadPage();
    </script>

    <script type="module" src="./src/js/pages/category.js"></script>

</body>

</html>
