<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Brand Comparison | Social Listening Dashboard</title>

    <link href="dist/output.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>

    <!-- Load Shared Layout -->
    <div id="layout"></div>

    <script type="module">
        import { loadLayout } from './src/js/layout-loader.js';
        import { loadShareOfVoiceData, loadComparisonKeywordFrequencyData } from './src/js/pages/share.js';

        async function loadPage() {
            // Wait for Chart.js to be available
            while (typeof Chart === 'undefined') {
                console.log('Waiting for Chart.js to load...');
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Load layout
            await loadLayout('sov');

            // Insert this page's content
            document.getElementById("page-content").innerHTML = `
                <h2 class="text-white text-2xl font-semibold mb-6">Category Comparison</h2>

                <!-- Category Selector Section -->
                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg mb-6">
                    <div class="text-white font-semibold text-lg mb-4">
                        Select Category
                    </div>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-gray-400 text-sm mb-2">Category</label>
                            <select id="categorySelector" class="w-full bg-[#1e2433] text-white border border-[#3d4456] rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                                <option value="diaper">Diaper</option>
                                <option value="formula milk">Formula Milk</option>
                                <option value="weaning">Weaning</option>
                                <option value="hospital">Hospital</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Share of Voice Chart -->
                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4 border-b border-[#3d4456] pb-2">
                        <div class="text-white font-semibold text-lg">
                            Share of Voice
                        </div>
                        <button id="analyzeShareOfVoiceBtn" class="bg-[#C990B8] hover:bg-[#B87AA8] text-white px-4 py-1 rounded text-sm font-semibold transition">
                            Analyze
                        </button>
                    </div>
                    <div class="relative" style="min-height: 400px; position: relative;">
                        <canvas id="shareOfVoiceChart"></canvas>
                        <div id="loadingOverlay-shareOfVoiceChart" class="chart-loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Keyword Frequency Chart -->
                <div class="bg-[#2a3142] border border-[#3d4456] rounded-lg p-6 shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4 border-b border-[#3d4456] pb-2">
                        <div class="text-white font-semibold text-lg">
                            Keyword Frequency
                        </div>
                        <button id="analyzeKeywordFrequencyBtn" class="bg-[#C990B8] hover:bg-[#B87AA8] text-white px-4 py-1 rounded text-sm font-semibold transition">
                            Analyze
                        </button>
                    </div>
                    <div class="relative" style="min-height: 400px; position: relative;">
                        <canvas id="comparisonKeywordChart"></canvas>
                        <div id="loadingOverlay-comparisonKeywordChart" class="chart-loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }

                    .chart-loading-overlay {
                        display: none;
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(31, 37, 47, 0.95);
                        z-index: 10;
                        border-radius: 8px;
                        align-items: center;
                        justify-content: center;
                        flex-direction: column;
                    }

                    .chart-loading-overlay.active {
                        display: flex;
                    }

                    .loading-spinner {
                        border: 3px solid #3d4456;
                        border-top: 3px solid #4ab4deff;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        animation: spin 1s linear infinite;
                    }
                </style>
            `;

            // Add event listeners for individual analyze buttons
            document.getElementById('analyzeShareOfVoiceBtn').addEventListener('click', async () => {
                const category = document.getElementById('categorySelector').value;
                console.log('Analyzing Share of Voice for category:', category);
                await loadShareOfVoiceData(category);
            });

            document.getElementById('analyzeKeywordFrequencyBtn').addEventListener('click', async () => {
                const category = document.getElementById('categorySelector').value;
                console.log('Analyzing Keyword Frequency for category:', category);
                await loadComparisonKeywordFrequencyData(category);
            });

            // Listen for group chat changes (when checkboxes change in sidebar)
            window.addEventListener('groupChatChanged', async () => {
                const category = document.getElementById('categorySelector').value;
                console.log('Group chat selection changed, reloading data for category:', category);
                // Load sequentially to avoid race conditions
                await loadShareOfVoiceData(category);
                await loadComparisonKeywordFrequencyData(category);
                console.log('All category data loaded');
            });

            // Load default category on page load sequentially
            const defaultCategory = 'diaper';
            console.log('Loading default category data sequentially...');
            await loadShareOfVoiceData(defaultCategory);
            await loadComparisonKeywordFrequencyData(defaultCategory);
            console.log('Default category data loaded');
        }

        loadPage();
    </script>

    <script type="module" src="./src/js/pages/share.js"></script>

</body>

</html>
